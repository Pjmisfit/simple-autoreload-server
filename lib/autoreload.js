
/*
 * simple-autoreload-server v0.0.4 - 2014-02-13
 * <https://github.com/cytb/simple-autoreload-server>
 *
 * Copyright (c) 2014 cytb
 *
 * Licensed under the MIT License License.
 * <http://www.opensource.org/licenses/mit-license.php>
 */

function bind$(a,b,c){return function(){return(c||a)[b].apply(a,arguments)}}function partialize$(a,b,c){var d=this;return function(){var e,f=slice$.call(arguments),g=f.length,h=c.length,i=b?b.concat():[],j=c?c.concat():[];for(e=0;g>e;++e)i[j[0]]=f[e],j.shift();return h>g&&g?partialize$.apply(d,[a,i,j]):a.apply(d,i)}}var connect,colors,WebSocket,http,esteWatch,path,staticTransform,utils,defOptions,flatten,regexClone,newCopy,getLogger,createConnectStack,SimpleAutoreloadServer,slice$=[].slice,toString$={}.toString;connect=require("connect"),colors=require("colors"),WebSocket=require("faye-websocket"),http=require("http"),esteWatch=require("este-watch"),path=require("path"),staticTransform=require("connect-static-transform"),utils=require("./utils"),defOptions=require("./default-options"),flatten=utils.flatten,regexClone=utils.regexClone,newCopy=utils.newCopy,getLogger=utils.getLogger,createConnectStack=utils.createConnectStack,module.exports=function(a){var b,c;return b=c=new SimpleAutoreloadServer(a),b.init(),b.start(),b},SimpleAutoreloadServer=function(){function a(a){null==a&&(a={}),this.livingSockets=[],this.normalLog=getLogger(bind$(this,"logPrefix")),this.verbLog=function(){},this.setOptions(a)}a.displayName="SimpleAutoreloadServer";var b=a.prototype,c=a;return b.setOptions=function(a){var b,c=this;return null==a&&(a={}),b=newCopy(a,defOptions),"function"!=typeof b.onmessage&&(b.onmessage=function(){}),b.verbose&&(this.verbLog=function(a){var b;return b=slice$.call(arguments,1),c.normalLog.apply(c,[a.toString().green].concat(b))},connect.logger.token("prefix",function(){return c.logPrefix()+" httpd".green})),this.options=b},b.logPrefix=function(){var a,b,c;return a=process.pid,b=this.options.root,c=this.options.port,("[autoreload #"+a+" @"+b+" :"+c+"]").cyan},b.stop=function(){var a;return null!=(a=this.watcher)&&a.dispose(),null!=(a=this.server)&&a.close(),this.normalLog("Server stopped.")},b.start=function(){var a,b,c;return this.watcher.start(),a=this.server,a.listen(this.options.port),a.addListener("upgrade",this.createUpgradeListerner()),b=this.options.root.toString().green,c=this.options.port.toString().green,this.normalLog("Server started on :"+c+" at "+b)},b.init=function(){return this.watcher=this.createWatcher(),this.server=this.createServer()},b.createUpgradeListerner=function(){var a=this;return function(b,c,d){var e,f,g;if(WebSocket.isWebSocket(b))return e=c.remoteAddress+":"+c.remotePort,f=function(b){return a.verbLog("websocket",e,"-",b)},g=new WebSocket(b,c,d),a.livingSockets.push(g.on("open",function(){return f("new connection"),g.send(JSON.stringify({type:"open",client:!1}))}).on("message",function(b){var c;return c=b.data,f("received message",c),a.options.onmessage(c,g)}).on("close",function(){return f("connection closed"),a.livingSockets=a.livingSockets.filter(function(a){return a!==g})}))}},b.createWatcher=function(){var a,b,c,d,e,f;return a=this.options.root,b=this,c=this.constructor.createReloadMatcher(this.options.forceReload),d=esteWatch([a],function(d){var e,f,g;if(flatten([b.options.watch]).some(function(a){return"RegExp"===toString$.call(a).slice(8,-1)&&a.test(d.filepath)}))return b.verbLog("watch","event on",d.filepath),e=function(){try{return f=path.relative(a,d.filepath),!/^\//.test(f)&&"/"+f||""}catch(b){return g=b,""}}(),b.broadcast({type:"update",path:e,forceReload:c(e)})}),e=d.onDirChange,f=d,f.onDirChange=function(){var a;try{return e.apply(this,arguments)}catch(c){return a=c,b.normalLog("Exception".red,a)}},d},b.createServer=function(){var a,b;return a=this.options.root,b=http.createServer(connect().use(createConnectStack(function(a){return a.filter(Boolean)}(flatten([null,this.options.verbose&&connect.logger([":prefix :remote-addr :method",'":url HTTP/:http-version"',":status :referrer :user-agent"].join(" ")),c.createStrans(a,this.options.inject),this.options.listDirectory&&connect.directory(a,{icons:!0}),connect["static"](a)])))))},b.broadcast=function(a,b,c){var d,e=this;return null==b&&(b=this.livingSockets),null==c&&(c=this.options.broadcastDelay),d=JSON.stringify(a),partialize$.apply(this,[setTimeout,[void 0,c],[0]])(function(){return e.verbLog("broadcast","to "+b.length+" sockets :",d),b.forEach(function(a){return null!=a?a.send(d):void 0})})},a.applyRec=function(a,b){var c;switch(c=[toString$.call(a).slice(8,-1)],!1){case"Array"!==c[0]:return flatten(a).map(b);default:return[b(a)]}},a.createStrans=function(a,b){return this.applyRec(b,function(b){var c,d,e;switch(c=[toString$.call(b).slice(8,-1)],!1){case"Function"!==c[0]:return staticTransform({root:a,match:/^/gi,transform:function(a,c,d){return d(b(a,c))}});case"Object"!==c[0]:return d=newCopy(defOptions.inject,b),e=d.prepend?function(){return 0}:function(a){return a.length},staticTransform({root:a,match:d.file,transform:function(a,c,f){var g,h,i,j;return g=null!=(h=d.match.exec(c))?h:{0:c,index:0},i=g.index+e(g[0]),j=bind$(c,"slice"),f(j(0,i)+""+b.code+j(i))}});default:throw new Error("Unacceptable object: "+b)}})},a.createReloadMatcher=function(a){var b;return"boolean"==typeof a?function(){return a}:(b=this.applyRec(a,function(a){var b;switch(b=[toString$.call(a).slice(8,-1)],!1){case"Function"!==b[0]:return a;case"RegExp"!==b[0]:return bind$(a,"test");case"String"!==b[0]:return function(b){return a.indexOf(b>=0)};default:throw new Error("Unacceptable object: #option")}}),function(a){return b.some(function(b){return b(a)})})},a}();