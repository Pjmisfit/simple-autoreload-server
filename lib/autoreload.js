/*
 * simple-autoreload-server v0.0.1 - 2014-02-12
 * <https://github.com/cytb/simple-autoreload-server>
 *
 * Copyright (c) 2014 cytb
 *
 * Licensed under the MIT License.
 * <http://www.opensource.org/licenses/mit-license.php>
 */
function bind$(a,b,c){return function(){return(c||a)[b].apply(a,arguments)}}function partialize$(a,b,c){var d=this;return function(){var e,f=slice$.call(arguments),g=f.length,h=c.length,i=b?b.concat():[],j=c?c.concat():[];for(e=0;g>e;++e)i[j[0]]=f[e],j.shift();return h>g&&g?partialize$.apply(d,[a,i,j]):a.apply(d,i)}}var connect,colors,WebSocket,http,esteWatch,path,staticTransform,utils,defOptions,flatten,regexClone,newCopy,getLogger,createConnectStack,SimpleAutoreloadServer,slice$=[].slice,toString$={}.toString;connect=require("connect"),colors=require("colors"),WebSocket=require("faye-websocket"),http=require("http"),esteWatch=require("este-watch"),path=require("path"),staticTransform=require("connect-static-transform"),utils=require("./utils"),defOptions=require("./default-options"),flatten=utils.flatten,regexClone=utils.regexClone,newCopy=utils.newCopy,getLogger=utils.getLogger,createConnectStack=utils.createConnectStack,module.exports=function(a){var b,c;return b=c=new SimpleAutoreloadServer(a),b.init(),b.start(),b},SimpleAutoreloadServer=function(){function a(a){null==a&&(a={}),this.livingSockets=[],this.normalLog=getLogger(bind$(this,"logPrefix")),this.verbLog=function(){},this.setOptions(a)}a.displayName="SimpleAutoreloadServer";var b=a.prototype,c=a;return b.setOptions=function(a){var b,c=this;return null==a&&(a={}),b=newCopy(a,defOptions),"function"!=typeof b.onmessage&&(b.onmessage=function(){}),b.verbose&&(this.verbLog=function(a){var b;return b=slice$.call(arguments,1),c.normalLog.apply(c,[a.toString().green].concat(b))},connect.logger.token("prefix",function(){return c.logPrefix()+" httpd".green})),this.options=b},b.logPrefix=function(){var a,b,c;return a=process.pid,b=this.options.root,c=this.options.port,("[autoreload #"+a+" @"+b+" :"+c+"]").cyan},b.stop=function(){var a;return null!=(a=this.watcher)&&a.dispose(),null!=(a=this.server)&&a.close(),this.normalLog("Server stopped.")},b.start=function(){var a,b,c;return this.watcher.start(),a=this.server,a.listen(this.options.port),a.addListener("upgrade",this.createUpgradeListerner()),b=this.options.root.toString().green,c=this.options.port.toString().green,this.normalLog("Server started on :"+c+" at "+b)},b.init=function(){return this.watcher=this.createWatcher(),this.server=this.createServer()},b.createUpgradeListerner=function(){var a=this;return function(b,c,d){var e,f,g;if(WebSocket.isWebSocket(b))return e=c.remoteAddress+":"+c.remotePort,f=function(b){return a.verbLog("websocket",e,"-",b)},g=new WebSocket(b,c,d),a.livingSockets.push(g.on("open",function(){return f("new connection"),g.send(JSON.stringify({type:"open",client:!1}))}).on("message",function(b){var c;return c=b.data,f("received message",c),a.options.onmessage(c,g)}).on("close",function(){return f("connection closed"),a.livingSockets=a.livingSockets.filter(function(a){return a!==g})}))}},b.createWatcher=function(){var a,b,c,d,e;return a=this.options.root,b=this,c=esteWatch([a],function(c){var d,e,f;if(flatten([b.options.watch]).some(function(a){return"RegExp"===toString$.call(a).slice(8,-1)&&a.test(c.filepath)}))return b.verbLog("watch","event on",c.filepath),d=function(){try{return e=path.relative(a,c.filepath),!/^\//.test(e)&&"/"+e||""}catch(b){return f=b,""}}(),b.broadcast({type:"update",path:d})}),d=c.onDirChange,e=c,e.onDirChange=function(){var a;try{return d.apply(this,arguments)}catch(c){return a=c,b.normalLog("Exception".red,a)}},c},b.createServer=function(){var a,b;return a=this.options.root,b=http.createServer(connect().use(createConnectStack(function(a){return a.filter(Boolean)}(flatten([null,this.options.verbose&&connect.logger([":prefix :remote-addr :method",'":url HTTP/:http-version"',":status :referrer :user-agent"].join(" ")),c.createStrans(a,this.options.inject),this.options.listDirectory&&connect.directory(a,{icons:!0}),connect["static"](a)])))))},b.broadcast=function(a,b,c){var d,e=this;return null==b&&(b=this.livingSockets),null==c&&(c=this.options.broadcastDelay),d=JSON.stringify(a),partialize$.apply(this,[setTimeout,[void 0,c],[0]])(function(){return e.verbLog("broadcast","to "+b.length+" sockets :",d),b.forEach(function(a){return null!=a?a.send(d):void 0})})},a.createStrans=function(a,b,c){var d,e,f,g,h,i;switch(null==c&&(c=!0),d=arguments.callee,e=[toString$.call(b).slice(8,-1)],!1){case"Array"!==e[0]:return c||function(){throw new Error("autoreload -\nthe injection option has too deep recursion.")}(),b.map(function(b){return d(a,b[0],!1)});case"Function"!==e[0]:return f=b,g=staticTransform({root:a,match:/^/gi,transform:function(a,b,c){return c(f(a,b))}}),[g];case"Object"!==e[0]:return h=newCopy(defOptions.inject,b),i=h.prepend?function(){return 0}:function(a){return a.length},g=staticTransform({root:a,match:h.file,transform:function(a,c,d){var e,f,g,j;return e=null!=(f=h.match.exec(c))?f:{0:c,index:0},g=e.index+i(e[0]),j=bind$(c,"slice"),d(j(0,g)+""+b.code+j(g))}}),[g]}},a}();