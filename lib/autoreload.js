
/*
 * simple-autoreload-server v0.0.7 - 2014-02-18
 * <https://github.com/cytb/simple-autoreload-server>
 *
 * Copyright (c) 2014 cytb
 *
 * Licensed under the MIT License License.
 * <http://www.opensource.org/licenses/mit-license.php>
 */

function partialize$(a,b,c){var d=this;return function(){var e,f=slice$.call(arguments),g=f.length,h=c.length,i=b?b.concat():[],j=c?c.concat():[];for(e=0;g>e;++e)i[j[0]]=f[e],j.shift();return h>g&&g?partialize$.apply(d,[a,i,j]):a.apply(d,i)}}function bind$(a,b,c){return function(){return(c||a)[b].apply(a,arguments)}}var connect,colors,WebSocket,http,path,staticTransform,utils,watch,defaultAllOptions,defOptions,flatten,regexClone,newCopy,getLogger,createConnectStack,SimpleAutoreloadServer,slice$=[].slice,toString$={}.toString,this$=this;connect=require("connect"),colors=require("colors"),WebSocket=require("faye-websocket"),http=require("http"),path=require("path"),staticTransform=require("connect-static-transform"),utils=require("./utils"),watch=require("./watch"),defaultAllOptions=require("./options"),defOptions=defaultAllOptions.defaultModuleOptions,flatten=utils.flatten,regexClone=utils.regexClone,newCopy=utils.newCopy,getLogger=utils.getLogger,createConnectStack=utils.createConnectStack,module.exports=function(a){var b,c;return b=c=new SimpleAutoreloadServer(a),b.init(),b.start(),b},SimpleAutoreloadServer=function(){function a(a){var c=this;null==a&&(a={}),this.livingSockets=[],this.normalLog=getLogger(function(){return d.logPrefix("localhost:"+c.options.port)}),this.verbLog=function(){},this.errorLog=b("red"),this.setOptions(a),this.running=!1}a.displayName="SimpleAutoreloadServer";var b,c=a.prototype,d=a;return b=function(a){return function(b){var c;return c=slice$.call(arguments,1),this.normalLog.apply(this,[b.toString()[a]].concat(c))}},c.setOptions=function(a){var c;return null==a&&(a={}),c=newCopy(a,defOptions),"function"!=typeof c.onmessage&&(c.onmessage=function(){}),c.verbose&&(this.verbLog=b("green")),this.options=c},c.stop=function(){var a;return null!=(a=this.watcher)&&a.stop(),null!=(a=this.server)&&a.close(),this.running=!1,this.normalLog("Server stopped.")},c.start=function(){var a,b,c;return this.running&&this.stop(),this.watcher.start(),a=this.server,a.listen(this.options.port),a.addListener("upgrade",this.createUpgradeListerner()),b=this.options.port.toString().green,c=this.options.root.toString().green,this.running=!0,this.normalLog("Server started on :"+b+" at "+c)},c.init=function(){return this.watcher=this.createWatcher(),this.server=this.createServer()},c.createUpgradeListerner=function(){var a=this;return function(b,c,d){var e,f,g;if(WebSocket.isWebSocket(b))return e=c.remoteAddress+":"+c.remotePort,f=function(b){return a.verbLog("websocket",e,"-",b)},g=new WebSocket(b,c,d),a.livingSockets.push(g.on("open",function(){return f("new connection"),g.send(JSON.stringify({type:"open",client:!1}))}).on("message",function(b){var c;return c=b.data,f("received message",c),a.options.onmessage(c,g)}).on("close",function(){return f("connection closed"),a.livingSockets=a.livingSockets.filter(function(a){return a!==g})}))}},c.createWatcher=function(){var a,b,c,d,e;return a=this.options.root,b=path.resolve(this.options.root),c=this,d=this.constructor.createReloadMatcher(this.options.forceReload),e=watch({root:a,delay:this.options.watchDelay,onChange:function(b,e){var f,g,h;if("error"===b)return void c.errorLog("watch","error".red,e);if(flatten([c.options.watch]).some(function(a){return"RegExp"===toString$.call(a).slice(8,-1)&&a.test(e)}))return c.verbLog("watch","event on",e),f=function(){try{return g=path.relative(a,e),!/^\//.test(g)&&"/"+g||""}catch(b){return h=b,""}}(),c.broadcast({type:"update",path:f,forceReload:d(f)})}})},c.createServer=function(){var a,b;return a=path.resolve(this.options.root),b=http.createServer(connect().use(createConnectStack(function(a){return a.filter(Boolean)}(flatten([null,this.options.verbose&&connect.logger([":ar-prefix :remote-addr :method",'":url HTTP/:http-version"',":status :referrer :user-agent"].join(" ")),d.createStrans(a,this.options.inject),this.options.listDirectory&&connect.directory(a,{icons:!0}),connect["static"](a)])))))},c.broadcast=function(a,b,c){var d,e=this;return null==b&&(b=this.livingSockets),null==c&&(c=this.options.broadcastDelay),d=JSON.stringify(a),partialize$.apply(this,[setTimeout,[void 0,c],[0]])(function(){return e.verbLog("broadcast","to "+b.length+" sockets :",d),b.forEach(function(a){return null!=a?a.send(d):void 0})})},a.logPrefix=function(a){var b;return b=process.pid,("[autoreload #"+b+" "+a+"]").cyan},a.applyRec=function(a,b){var c;switch(c=[toString$.call(a).slice(8,-1)],!1){case"Array"!==c[0]:return flatten(a).map(b);default:return[b(a)]}},a.createStrans=function(a,b){return this.applyRec(b,function(b){var c,d,e;switch(c=[toString$.call(b).slice(8,-1)],!1){case"Function"!==c[0]:return staticTransform({root:a,match:/^/gi,transform:function(a,c,d){return d(b(a,c))}});case"Object"!==c[0]:return d=newCopy(defOptions.inject,b),e=d.prepend?function(){return 0}:function(a){return a.length},staticTransform({root:a,match:d.file,transform:function(a,c,f){var g,h,i,j;return g=null!=(h=d.match.exec(c))?h:{0:c,index:0},i=g.index+e(g[0]),j=bind$(c,"slice"),f(j(0,i)+""+b.code+j(i))}});default:throw new Error("Unacceptable object: "+b)}})},a.createReloadMatcher=function(a){var b;return"boolean"==typeof a?function(){return a}:(b=this.applyRec(a,function(a){var b;switch(b=[toString$.call(a).slice(8,-1)],!1){case"Function"!==b[0]:return a;case"RegExp"!==b[0]:return bind$(a,"test");case"String"!==b[0]:return function(b){return a.indexOf(b>=0)};default:throw new Error("Unacceptable object: #option")}}),function(a){return b.some(function(b){return b(a)})})},a}(),connect.logger.token("ar-prefix",function(a){return SimpleAutoreloadServer.logPrefix(a.headers.host+" httpd".green)});